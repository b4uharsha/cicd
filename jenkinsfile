pipeline {
    agent any

    environment {
        // The default service account for general operations
        GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp-service-account') 
        // The Terraform service account credentials (stored in Jenkins credentials)
        TERRAFORM_SA_KEY = credentials('terraform-sa-key') 
    }

    stages {
        stage('Check GCP Service Account') {
            steps {
                script {
                    // Check if the default GCP service account can authenticate
                    sh '''
                        echo "Activating default service account"
                        gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
                        echo "Verifying access to GCP project"
                        gcloud projects describe $(gcloud config get-value project)
                    '''
                }
            }
        }

        stage('Use Terraform Service Account') {
            steps {
                script {
                    // Activate the Terraform service account
                    sh '''
                        echo "Activating Terraform service account: terraform-sa@testcicd-436812.iam.gserviceaccount.com"
                        gcloud auth activate-service-account terraform-sa@testcicd-436812.iam.gserviceaccount.com --key-file="$TERRAFORM_SA_KEY"
                        
                        # Verify that the service account is active and has access
                        echo "Verifying access to GCP project with Terraform service account"
                        gcloud projects describe $(gcloud config get-value project)
                    '''
                }
            }
        }

        stage('Ansible Setup') {
            steps {
                script {
                    dir('ansible') {
                        // Install required Ansible dependencies (if any)
                        sh 'ansible-galaxy install -r requirements.yml --force'
                    }
                }
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                script {
                    dir('ansible') {
                        // Run the Ansible playbook to list GCP resources using Terraform SA
                        sh 'ansible-playbook playbook.yml'
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully.'
        }

        failure {
            echo 'Pipeline failed.'
        }
    }
}
